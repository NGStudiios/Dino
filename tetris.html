<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tetris Avanzado - Móvil</title>
<style>
body {
  margin:0; padding:0;
  font-family:'Segoe UI', sans-serif;
  background:#111;
  display:flex; flex-direction:column;
  align-items:center;
  justify-content:center;
  color:#fff;
  touch-action:none;
}
h1 {
  font-size:1.8em;
  color:#00e5ff;
  text-shadow:0 0 5px #00e5ff,0 0 15px #00e5ff;
  margin-bottom:5px;
}
.tetris-container {
  display:flex; flex-direction:row; gap:15px;
  align-items:flex-start;
}
canvas {
  background:#222;
  border:3px solid #fff;
  image-rendering: pixelated;
}
.sidebar {
  display:flex; flex-direction:column; gap:10px;
  width:100px;
}
.sidebar div {
  font-size:1.1em;
  text-align:center;
  padding:5px;
  border:2px solid #00e5ff;
  border-radius:5px;
  box-shadow:0 0 5px #00e5ff;
}
.next-piece {
  width:4rem; height:4rem; margin:auto; background:#111;
  display:flex; align-items:center; justify-content:center;
}
.controls {
  display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:10px;
}
.controls button {
  padding:15px; font-size:1.2em; background:#00e5ff;
  border:none; border-radius:5px; color:#111;
  min-width:60px; touch-action: manipulation;
}
.controls button:hover{background:#00b3cc;}
</style>
</head>
<body>
<h1>TETRIS AVANZADO</h1>
<div class="tetris-container">
  <canvas id="tetris" width="240" height="480"></canvas>
  <div class="sidebar">
    <div>Puntaje: <span id="score">0</span></div>
    <div>Líneas: <span id="lines">0</span></div>
    <div>Nivel: <span id="level">0</span></div>
    <div>Próxima:</div>
    <canvas id="next" width="80" height="80" class="next-piece"></canvas>
  </div>
</div>
<div class="controls">
  <button id="left">←</button>
  <button id="rotate">⟳</button>
  <button id="right">→</button>
  <button id="down">↓</button>
  <button id="restart">Reiniciar</button>
</div>

<script>
const canvas=document.getElementById('tetris');
const context=canvas.getContext('2d');
context.scale(24,24);

const nextCanvas=document.getElementById('next');
const nextCtx=nextCanvas.getContext('2d');
nextCtx.scale(20,20);

const scoreEl=document.getElementById('score');
const linesEl=document.getElementById('lines');
const levelEl=document.getElementById('level');

const arenaWidth=10,arenaHeight=20;
function createMatrix(w,h){return Array.from({length:h},()=>Array(w).fill(0));}
function createPiece(type){
  if(type==='T')return [[0,0,0],[1,1,1],[0,1,0]];
  if(type==='O')return [[2,2],[2,2]];
  if(type==='L')return [[0,0,3],[3,3,3],[0,0,0]];
  if(type==='J')return [[4,0,0],[4,4,4],[0,0,0]];
  if(type==='I')return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
  if(type==='S')return [[0,6,6],[6,6,0],[0,0,0]];
  if(type==='Z')return [[7,7,0],[0,7,7],[0,0,0]];
}
const colors=[null,'#ff0d72','#0dc2ff','#0dff72','#f538ff','#ff8e0d','#ffe138','#3877ff'];
let arena=createMatrix(arenaWidth,arenaHeight);
let dropCounter=0,dropInterval=1000,lastTime=0;

const player={
  pos:{x:0,y:0},
  matrix:null,
  score:0,
  lines:0,
  level:0,
  next:null
};
function merge(a,p){p.matrix.forEach((row,y)=>row.forEach((v,x)=>{if(v!==0)a[y+p.pos.y][x+p.pos.x]=v;}));}
function collide(a,p){for(let y=0;y<p.matrix.length;y++){for(let x=0;x<p.matrix[y].length;x++){if(p.matrix[y][x]!==0&&(a[y+p.pos.y]&&a[y+p.pos.y][x+p.pos.x])!==0)return true;}}return false;}
function rotate(matrix,dir){for(let y=0;y<matrix.length;y++)for(let x=0;x<y;x++) [matrix[x][y],matrix[y][x]]=[matrix[y][x],matrix[x][y]];if(dir>0)matrix.forEach(r=>r.reverse());else matrix.reverse();}
function arenaSweep(){
  let rowCount=0;
  outer:for(let y=arena.length-1;y>=0;y--){
    for(let x=0;x<arena[y].length;x++)if(arena[y][x]===0)continue outer;
    const row=arena.splice(y,1)[0].fill(0);
    arena.unshift(row);
    rowCount++;y++;
  }
  if(rowCount>0){player.score+=rowCount*10*rowCount;player.lines+=rowCount;player.level=Math.floor(player.lines/5);}
}
function drawMatrix(matrix,offset,ctx,colorOverride){
  matrix.forEach((row,y)=>row.forEach((value,x)=>{
    if(value!==0){
      ctx.fillStyle=colorOverride||colors[value];
      ctx.fillRect(x+offset.x,y+offset.y,1,1);
      ctx.strokeStyle='#000';ctx.lineWidth=0.05;ctx.strokeRect(x+offset.x,y+offset.y,1,1);
    }
  }));
}
function draw(){
  context.fillStyle='#222';context.fillRect(0,0,canvas.width,canvas.height);
  drawMatrix(arena,{x:0,y:0},context);
  drawGhost();
  drawMatrix(player.matrix,player.pos,context);
  drawNext();
}
function drawNext(){
  nextCtx.fillStyle='#111';nextCtx.fillRect(0,0,nextCanvas.width,nextCanvas.height);
  drawMatrix(player.next,{x:0,y:0},nextCtx);
}
function drawGhost(){
  const ghost={pos:{x:player.pos.x,y:player.pos.y},matrix:player.matrix};
  while(!collide(arena,ghost))ghost.pos.y++;
  ghost.pos.y--;
  drawMatrix(ghost.matrix,ghost.pos,context,'rgba(255,255,255,0.3)');
}
function playerDrop(){player.pos.y++;if(collide(arena,player)){player.pos.y--;merge(arena,player);arenaSweep();updateScore();playerReset();if(collide(arena,player)){arena=createMatrix(arenaWidth,arenaHeight);player.score=0;player.lines=0;player.level=0;updateScore();}}dropCounter=0;}
function playerMove(dir){player.pos.x+=dir;if(collide(arena,player))player.pos.x-=dir;}
function playerRotate(dir){const pos=player.pos.x;rotate(player.matrix,dir);let offset=1;while(collide(arena,player)){player.pos.x+=offset;offset=-(offset+(offset>0?1:-1));if(offset>player.matrix[0].length){rotate(player.matrix,-dir);player.pos.x=pos;return;}}}
function playerReset(){player.matrix=player.next||createPiece(randomPiece());player.next=createPiece(randomPiece());player.pos.y=0;player.pos.x=(arena[0].length/2|0)-(player.matrix[0].length/2|0);}
function randomPiece(){return'IJLOSTZ'[Math.floor(Math.random()*7)];}
function update(time=0){const deltaTime=time-lastTime;lastTime=time;dropCounter+=deltaTime;if(dropCounter>dropInterval-Math.min(player.level*80,800))playerDrop();draw();requestAnimationFrame(update);}
function updateScore(){scoreEl.innerText=player.score;linesEl.innerText=player.lines;levelEl.innerText=player.level;}

document.addEventListener('keydown',e=>{if(e.keyCode===37)playerMove(-1);else if(e.keyCode===39)playerMove(1);else if(e.keyCode===40)playerDrop();else if(e.keyCode===81)playerRotate(-1);else if(e.keyCode===87)playerRotate(1);});
const hold={left:null,right:null,down:null};
function startHold(button,fn){fn();hold[button]=setInterval(fn,50);}
function stopHold(button){clearInterval(hold[button]);hold[button]=null;}
document.getElementById('left').addEventListener('touchstart',()=>startHold('left',()=>playerMove(-1)));document.getElementById('left').addEventListener('touchend',()=>stopHold('left'));
document.getElementById('right').addEventListener('touchstart',()=>startHold('right',()=>playerMove(1)));document.getElementById('right').addEventListener('touchend',()=>stopHold('right'));
document.getElementById('down').addEventListener('touchstart',()=>startHold('down',()=>playerDrop()));document.getElementById('down').addEventListener('touchend',()=>stopHold('down'));
document.getElementById('rotate').addEventListener('touchstart',()=>playerRotate(1));
document.getElementById('restart').addEventListener('touchstart',()=>{arena=createMatrix(arenaWidth,arenaHeight);player.score=0;player.lines=0;player.level=0;playerReset();updateScore();});

playerReset();
updateScore();
update();
</script>
</body>
</html>
