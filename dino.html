<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Dinosaurio Prácticamente</title>
<style>
  :root{
    --sky:#87CEEB;
    --ground:#8B4513;
    --neon:#00e5ff;
  }
  html,body{ margin:0; padding:0; background:var(--sky); font-family:system-ui,Segoe UI,Arial,sans-serif; }
  .hud{
    position:fixed; inset:0 0 auto 0; display:flex; justify-content:center; gap:24px;
    padding:8px 12px; color:#fff; text-shadow:0 0 6px #000;
    font-weight:600; user-select:none; pointer-events:none;
  }
  .hud span{ pointer-events:none; }
  canvas{
    display:block; margin:0 auto; background:var(--sky);
    border:3px solid var(--neon); box-shadow:0 10px 30px rgba(0,0,0,.35);
    touch-action:none; /* evita scroll en móvil al tocar canvas */
  }
  .controls{
    position:fixed; inset:auto 0 18px 0; display:flex; justify-content:space-between;
    padding:0 18px; gap:12px; pointer-events:auto;
  }
  .btn{
    -webkit-tap-highlight-color: transparent;
    width:min(42vw,170px); height:64px; border:none; border-radius:16px;
    background:var(--neon); color:#111; font-weight:800; font-size:clamp(16px,4vw,20px);
    box-shadow:0 6px 18px rgba(0,0,0,.35); transition:transform .05s ease;
  }
  .btn:active{ transform:translateY(2px) scale(.98); }
  @media (min-width:900px){
    .controls{ display:none; } /* en desktop ocultamos botones, usamos teclado */
  }
  .tip{
    position:fixed; right:10px; top:10px; color:#003; background:rgba(255,255,255,.6);
    padding:4px 8px; border-radius:8px; font-size:12px; user-select:none;
  }
</style>
</head>
<body>
  <div class="hud">
    <span>Puntaje: <strong id="score">0</strong></span>
    <span>Récord: <strong id="best">0</strong></span>
  </div>
  <div class="tip">PC: Space salta · Flecha ↓ agacha</div>
  <canvas id="game" width="1000" height="320" aria-label="Juego del Dinosaurio"></canvas>

  <div class="controls">
    <button id="jumpBtn" class="btn">↑ Saltar</button>
    <button id="duckBtn" class="btn">↓ Agachar</button>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // ======== IMÁGENES ========
  const dinoImg = new Image(); dinoImg.src = 'dino.png';
  const cactusImg = new Image(); cactusImg.src = 'captus.png';
  const meteorImg = new Image(); meteorImg.src = 'meteor.png';

  // ======== HUD ========
  const scoreEl = document.getElementById('score');
  const bestEl  = document.getElementById('best');
  let best = parseInt(localStorage.getItem('dinoRecord') || '0', 10);
  bestEl.textContent = best;

  // ======== MUNDO ========
  const W = canvas.width, H = canvas.height;
  const groundH = 56; // suelo alto (marrón)
  let frame = 0;
  let running = true;

  // Nubes (dibujadas con vectores, sin imágenes)
  const clouds = Array.from({length:6}, () => ({
    x: Math.random()*W, y: 10 + Math.random()*90,
    r: 18 + Math.random()*22, speed: .2 + Math.random()*.4
  }));

  // ======== DINO ========
  const DINO_BASE = { w: 90, h: 90 }; // grande
  const dino = {
    x: 70,
    y: H - groundH - DINO_BASE.h,
    w: DINO_BASE.w,
    h: DINO_BASE.h,
    vy: 0,
    gravity: 1.3,
    jumpV: -21,
    onGround: true,
    duck: false
  };

  // ======== OBSTÁCULOS ========
  let speed = 7;       // velocidad base del mundo (aumenta con el tiempo)
  let score = 0;

  const cacti = [];    // cactus por el suelo
  const meteors = [];  // meteoritos diagonales

  function spawnCactus(){
    // cactus grande
    const h = 70 + Math.floor(Math.random()*40); // 70-110 px
    const w = Math.max(34, Math.floor(h * 0.55)); // proporcional
    cacti.push({
      x: W + 10,
      y: H - groundH - h,
      w, h
    });
  }

  function spawnMeteor(){
    // entran desde arriba, diagonal (derecha->izquierda) o (izq->der)
    const size = 36 + Math.random()*48;
    const fromRight = Math.random() < 0.6; // la mayoría desde la derecha
    const startX = fromRight ? W + 40 : -40 - size;
    const targetX = fromRight ? -120 : W + 120;
    const startY = -60 - Math.random()*120;
    const travelT = 120 + Math.random()*120; // frames de viaje
    const vx = (targetX - startX) / travelT;
    const vy = (H - groundH - size - startY) / travelT;

    meteors.push({
      x: startX, y: startY, w: size, h: size,
      vx, vy: vy + (Math.random()*0.6), // un pelín más vertical
      spin: (Math.random()<.5? -1:1) * (0.02+Math.random()*0.05),
      angle: 0
    });
  }

  // ======== UTILS ========
  function rectsOverlap(a,b){
    return a.x < b.x + b.w && a.x + a.w > b.x &&
           a.y < b.y + b.h && a.y + a.h > b.y;
  }
  function dinoRect(){
    // cuando se agacha, bajamos la altura (hitbox) y subimos el y para "agachado"
    if (dino.duck){
      const h = Math.floor(DINO_BASE.h * 0.55); // 50-55% de alto
      return { x: dino.x, y: dino.y + (DINO_BASE.h - h), w: dino.w, h };
    }
    return { x: dino.x, y: dino.y, w: dino.w, h: dino.h };
  }

  // ======== ENTRADAS ========
  function jump(){
    if (!running) return;
    if (dino.onGround && !dino.duck){
      dino.vy = dino.jumpV;
      dino.onGround = false;
    }
  }
  function setDuck(v){
    if (!running) return;
    dino.duck = v;
  }

  // Teclado
  addEventListener('keydown', (e)=>{
    if (e.code === 'Space'){ e.preventDefault(); jump(); }
    if (e.code === 'ArrowUp'){ e.preventDefault(); jump(); }
    if (e.code === 'ArrowDown'){ e.preventDefault(); setDuck(true); }
  }, {passive:false});
  addEventListener('keyup', (e)=>{
    if (e.code === 'ArrowDown') setDuck(false);
  });

  // Botones táctiles
  const jumpBtn = document.getElementById('jumpBtn');
  const duckBtn = document.getElementById('duckBtn');

  const prevent = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); };

  ['touchstart','pointerdown','mousedown'].forEach(ev=>{
    jumpBtn.addEventListener(ev,(e)=>{ prevent(e); jump(); });
  });
  ['touchstart','pointerdown','mousedown'].forEach(ev=>{
    duckBtn.addEventListener(ev,(e)=>{ prevent(e); setDuck(true); });
  });
  ['touchend','pointerup','mouseup','mouseleave','touchcancel'].forEach(ev=>{
    duckBtn.addEventListener(ev,(e)=>{ prevent(e); setDuck(false); });
  });

  // Tocar el canvas = saltar (móvil)
  ['touchstart','pointerdown'].forEach(ev=>{
    canvas.addEventListener(ev,(e)=>{ prevent(e); jump(); });
  });

  // ======== LOOP ========
  function update(){
    if (!running) return;

    // Fondo
    ctx.clearRect(0,0,W,H);
    // CIELO
    ctx.fillStyle = '#87CEEB';
    ctx.fillRect(0,0,W,H);

    // Nubes
    ctx.fillStyle = 'rgba(255,255,255,.95)';
    clouds.forEach(c=>{
      // dibujamos nube simple con círculos
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r, 0, Math.PI*2);
      ctx.arc(c.x + c.r*0.9, c.y+4, c.r*0.8, 0, Math.PI*2);
      ctx.arc(c.x - c.r*0.8, c.y+6, c.r*0.7, 0, Math.PI*2);
      ctx.fill();
      c.x -= c.speed;
      if (c.x < -200) { c.x = W + 80; c.y = 10 + Math.random()*90; }
    });

    // SUELO
    ctx.fillStyle = '#8B4513';
    ctx.fillRect(0, H-groundH, W, groundH);

    // Spawns
    if (frame % Math.max(40, 90 - Math.floor(score/50)) === 0) spawnCactus();
    if (frame % Math.max(90, 220 - Math.floor(score/30)) === 0) spawnMeteor();

    // Move Cactus
    for (let i=0; i<cacti.length; i++){
      const c = cacti[i];
      c.x -= speed;
    }
    // Clean Cactus
    while(cacti.length && cacti[0].x + cacti[0].w < -20) cacti.shift();

    // Move Meteors
    for (let i=0; i<meteors.length; i++){
      const m = meteors[i];
      m.x += m.vx;
      m.y += m.vy;
      m.angle += m.spin;
    }
    // Clean Meteors
    for (let i=meteors.length-1; i>=0; i--){
      const m = meteors[i];
      if (m.y > H + 100 || m.x < -200 || m.x > W + 200) meteors.splice(i,1);
    }

    // Física dino (si está en el aire, gravedad; si está agachado, igual aplica gravedad)
    dino.vy += dino.gravity;
    dino.y += dino.vy;

    // Piso: no traba, permite despegar normal
    const floorY = H - groundH - dino.h;
    if (dino.y > floorY){
      dino.y = floorY;
      dino.vy = 0;
      dino.onGround = true;
    } else {
      dino.onGround = false;
    }

    // Dibujo Dino (con agachado)
    const dRect = dinoRect();
    // Si la imagen no cargó todavía, fallback a rectángulo
    if (dinoImg.complete && dinoImg.naturalWidth){
      if (dino.duck){
        // dibujamos la mitad inferior para simular agachado
        ctx.drawImage(dinoImg, dino.x, dRect.y, dRect.w, dRect.h);
      } else {
        ctx.drawImage(dinoImg, dino.x, dino.y, dino.w, dino.h);
      }
    } else {
      ctx.fillStyle = '#444';
      ctx.fillRect(dRect.x, dRect.y, dRect.w, dRect.h);
    }

    // Dibujo cactus
    for (const c of cacti){
      if (cactusImg.complete && cactusImg.naturalWidth){
        ctx.drawImage(cactusImg, c.x, c.y, c.w, c.h);
      } else {
        ctx.fillStyle = '#2d7d2d';
        ctx.fillRect(c.x, c.y, c.w, c.h);
      }
    }

    // Dibujo meteoritos (con rotación)
    for (const m of meteors){
      if (meteorImg.complete && meteorImg.naturalWidth){
        ctx.save();
        ctx.translate(m.x + m.w/2, m.y + m.h/2);
        ctx.rotate(m.angle);
        ctx.drawImage(meteorImg, -m.w/2, -m.h/2, m.w, m.h);
        ctx.restore();
      } else {
        ctx.fillStyle = '#663300';
        ctx.beginPath();
        ctx.arc(m.x + m.w/2, m.y + m.h/2, m.w/2, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // Colisiones
    // - cactus
    for (const c of cacti){
      if (rectsOverlap(dRect, c)){ return gameOver(); }
    }
    // - meteoritos
    for (const m of meteors){
      const mRect = { x:m.x, y:m.y, w:m.w, h:m.h };
      if (rectsOverlap(dRect, mRect)){ return gameOver(); }
    }

    // Puntaje y dificultad
    score += 0.25; // ~4 por segundo a 60fps
    const shown = Math.floor(score);
    scoreEl.textContent = shown;
    if (shown > best){
      best = shown;
      bestEl.textContent = best;
      localStorage.setItem('dinoRecord', String(best));
    }
    // Aumenta velocidad suave con el tiempo (cap en 16)
    speed = Math.min(16, 7 + score/120);

    frame++;
    requestAnimationFrame(update);
  }

  function gameOver(){
    running = false;
    // Flash rojo
    ctx.fillStyle = 'rgba(255,0,0,.3)';
    ctx.fillRect(0,0,W,H);
    // Texto
    ctx.fillStyle = '#111';
    ctx.font = '700 28px system-ui,Segoe UI,Arial';
    ctx.textAlign = 'center';
    ctx.fillText('¡Chocaste! Space/Toque para reiniciar', W/2, H/2);
    // Listener de reinicio único
    const restart = (e)=>{
      e.preventDefault();
      removeEventListener('keydown', restartKey, {passive:false});
      canvas.removeEventListener('touchstart', restart, {passive:false});
      canvas.removeEventListener('pointerdown', restart, {passive:false});
      reset();
    };
    const restartKey = (e)=>{
      if (e.code === 'Space' || e.code === 'Enter'){
        restart(e);
      }
    };
    addEventListener('keydown', restartKey, {passive:false});
    ['touchstart','pointerdown'].forEach(ev=>{
      canvas.addEventListener(ev, restart, {passive:false});
    });
  }

  function reset(){
    // estado base
    cacti.length = 0;
    meteors.length = 0;
    score = 0;
    frame = 0;
    speed = 7;
    dino.y = H - groundH - dino.h;
    dino.vy = 0;
    dino.duck = false;
    dino.onGround = true;
    running = true;
    update();
  }

  // Start!
  reset();
})();
</script>
</body>
</html>
